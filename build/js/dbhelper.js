function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var restaurantsdb,IndexedDatabase=function(){function c(){_classCallCheck(this,c)}return _createClass(c,null,[{key:"getRestaurantsInformation",value:function(){return restaurantsdb?new Promise(function(n,r){restaurantsdb.then(function(e){var t=e.transaction(c.restaurantsObjectStoreName,"readonly").objectStore(c.restaurantsObjectStoreName).getAll();t.onsuccess=function(e){n(e.target.result)},t.onerror=function(){r("Error getting restaurants information from IndexedDB")}})}):Promise.resolve(null)}},{key:"getReviewsInformation",value:function(a){return restaurantsdb?new Promise(function(n,r){restaurantsdb.then(function(e){var t=e.transaction(c.reviewsObjectStoreName,"readonly").objectStore(c.reviewsObjectStoreName).index("restaurant_id").getAll(parseInt(a));t.onsuccess=function(e){n(e.target.result)},t.onerror=function(){r("Error getting reviews information from IndexedDB")}})}).then(function(r){return new Promise(function(n,t){c.getPendingReviewsInformation(a).then(function(e){var t=r.concat(e);n(t)}).catch(function(e){t(e)})})}):Promise.resolve(null)}},{key:"getPendingReviewsInformation",value:function(o){return restaurantsdb?new Promise(function(r,a){restaurantsdb.then(function(e){var t,n=e.transaction(c.pendingReviewsOSN,"readonly").objectStore(c.pendingReviewsOSN).index("restaurant_id");(t=o&&0<o?n.getAll(parseInt(o)):n.getAll()).onsuccess=function(e){r(e.target.result)},t.onerror=function(){a("Error getting pending reviews information from IndexedDB")}})}):Promise.resolve(null)}},{key:"pushRestaurantsInformation",value:function(s){restaurantsdb&&restaurantsdb.then(function(e){var t=e.transaction(c.restaurantsObjectStoreName,"readwrite").objectStore(c.restaurantsObjectStoreName),n=!0,r=!1,a=void 0;try{for(var o,i=s[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var u=o.value;t.put(u)}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}})}},{key:"pushReviewsInformation",value:function(s){restaurantsdb&&restaurantsdb.then(function(e){var t=e.transaction(c.reviewsObjectStoreName,"readwrite").objectStore(c.reviewsObjectStoreName),n=!0,r=!1,a=void 0;try{for(var o,i=s[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var u=o.value;t.put(u)}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}})}},{key:"pushPendingReviewsInformation",value:function(s){restaurantsdb&&restaurantsdb.then(function(e){var t=e.transaction(c.pendingReviewsOSN,"readwrite").objectStore(c.pendingReviewsOSN),n=!0,r=!1,a=void 0;try{for(var o,i=s[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){var u=o.value;u.id=parseInt(Date.now()),t.put(u)}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}})}},{key:"clearPendingReviews",value:function(){return restaurantsdb?new Promise(function(n,r){restaurantsdb.then(function(e){var t=e.transaction(c.pendingReviewsOSN,"readwrite").objectStore(c.pendingReviewsOSN).clear();t.onsuccess=function(){n("Success")},t.onerror=function(){r("Error clearing Pending Reviews from IndexedDB")}})}):Promise.resolve(null)}},{key:"openAndConfigureDatabase",value:function(){restaurantsdb=this.openIndexedDatabase(c.databaseName,c.currentDbVersion,function(e){e.createObjectStore(c.restaurantsObjectStoreName,{keyPath:"id"});var t=e.createObjectStore(c.reviewsObjectStoreName,{keyPath:"id"}),n=e.createObjectStore(c.pendingReviewsOSN,{keyPath:"id"});t.createIndex("restaurant_id","restaurant_id"),n.createIndex("restaurant_id","restaurant_id")})}},{key:"openIndexedDatabase",value:function(r,a,o){return window.indexedDB?new Promise(function(e,t){var n=indexedDB.open(r,a);n.onerror=function(e){t("Error at opening database: "+r+", error: "+e)},n.onupgradeneeded=function(e){o(e.target.result)},n.onsuccess=function(){e(this.result)}}):Promise.resolve(null)}},{key:"databaseName",get:function(){return"restaurantApp"}},{key:"currentDbVersion",get:function(){return 1}},{key:"restaurantsObjectStoreName",get:function(){return"restaurants"}},{key:"reviewsObjectStoreName",get:function(){return"reviews"}},{key:"pendingReviewsOSN",get:function(){return"pendingreviews"}}]),c}(),DBHelper=function(){function c(){_classCallCheck(this,c)}return _createClass(c,null,[{key:"fetchRestaurants",value:function(s){fetch(c.RESTAURANTS_PATH).then(function(e){if(!e.ok)throw Error(e.statusText);return e.json()}).then(function(e){s(null,e),IndexedDatabase.pushRestaurantsInformation(e)}).catch(function(u){IndexedDatabase.getRestaurantsInformation().then(function(e){if(!e||e.length<=0){var t="Request failed. Returned status of ".concat(u);s(t,null)}else{var n=!0,r=!1,a=void 0;try{for(var o,i=e[Symbol.iterator]();!(n=(o=i.next()).done);n=!0){o.value.offline=!0}}catch(e){r=!0,a=e}finally{try{n||null==i.return||i.return()}finally{if(r)throw a}}s(null,e)}})})}},{key:"fetchRestaurantById",value:function(o,i){c.fetchReviewsByRestaurant(o).then(function(a){fetch(c.RESTAURANTS_PATH+"/"+o).then(function(e){if(!e.ok)throw Error(e.statusText);return e.json()}).then(function(e){IndexedDatabase.pushRestaurantsInformation([e]),a&&(e.reviews=a),i(null,e)}).catch(function(r){IndexedDatabase.getRestaurantsInformation().then(function(e){if(!e||e.length<=0){var t="Request failed. Returned status of ".concat(r);i(t,null)}else{var n=e.find(function(e){return e.id==o});n.offline=!0,n?(a&&(n.reviews=a),i(null,n)):i("Restaurant does not exist",null)}})})})}},{key:"fetchReviewsByRestaurant",value:function(t){return fetch(c.REVIEWS_PATH+"/?restaurant_id="+t).then(function(e){if(!e.ok)throw Error(e.statusText);return e.json()}).then(function(e){return IndexedDatabase.pushReviewsInformation(e),e}).catch(function(e){return IndexedDatabase.getReviewsInformation(t).then(function(e){return!e||e.length<=0?null:e})})}},{key:"fetchReviews",value:function(){fetch(c.REVIEWS_PATH).then(function(e){if(e.ok)return e.json()}).then(function(e){IndexedDatabase.pushReviewsInformation(e)})}},{key:"escapeHtml",value:function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}},{key:"sendReview",value:function(t,n,r,a){var o={restaurant_id:parseInt(a),name:t.value,rating:r.value,comments:c.escapeHtml(n.value)};return fetch(c.REVIEWS_PATH,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(function(e){if(!e.ok)throw Error(e.statusText);return{name:t.value,updatedAt:Date.now(),rating:parseInt(r.value),comments:c.escapeHtml(n.value)}}).then(function(e){return c.fetchReviewsByRestaurant(a),e}).catch(function(e){o.updatedAt=Date.now(),o.offline=!0;var t={restaurant_id:o.restaurant_id,name:o.name,rating:o.rating,comments:o.comments,updatedAt:o.updatedAt};return IndexedDatabase.pushPendingReviewsInformation([t]),o})}},{key:"fetchRestaurantByCuisine",value:function(r,a){c.fetchRestaurants(function(e,t){if(e)a(e,null);else{var n=t.filter(function(e){return e.cuisine_type==r});a(null,n)}})}},{key:"fetchRestaurantByNeighborhood",value:function(r,a){c.fetchRestaurants(function(e,t){if(e)a(e,null);else{var n=t.filter(function(e){return e.neighborhood==r});a(null,n)}})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(r,a,o){c.fetchRestaurants(function(e,t){if(e)o(e,null);else{var n=t;"all"!=r&&(n=n.filter(function(e){return e.cuisine_type==r})),"all"!=a&&(n=n.filter(function(e){return e.neighborhood==a})),o(null,n)}})}},{key:"fetchNeighborhoods",value:function(a){c.fetchRestaurants(function(e,n){if(e)a(e,null);else{var r=n.map(function(e,t){return n[t].neighborhood}),t=r.filter(function(e,t){return r.indexOf(e)==t});a(null,t)}})}},{key:"fetchCuisines",value:function(a){c.fetchRestaurants(function(e,n){if(e)a(e,null);else{var r=n.map(function(e,t){return n[t].cuisine_type}),t=r.filter(function(e,t){return r.indexOf(e)==t});a(null,t)}})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id=".concat(e.id)}},{key:"imageUrlForRestaurant",value:function(e){return"/img/".concat(e.photograph)}},{key:"mapMarkerForRestaurant",value:function(e,t){var n=new L.marker([e.latlng.lat,e.latlng.lng],{title:e.name,alt:e.name+" restaurant",url:c.urlForRestaurant(e)});return n.addTo(newMap),n}},{key:"sendPendingReviews",value:function(){IndexedDatabase.getPendingReviewsInformation().then(function(u){u&&0<u.length&&IndexedDatabase.clearPendingReviews().then(function(e){var t=!0,n=!1,r=void 0;try{for(var a,o=function(){var t=a.value,e={restaurant_id:t.restaurant_id,name:t.name,rating:t.rating,comments:t.comments};fetch(c.REVIEWS_PATH,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(function(e){if(!e.ok)throw Error(e.statusText)}).then(function(){c.fetchReviewsByRestaurant(parseInt(t.restaurant_id))}).catch(function(e){IndexedDatabase.pushPendingReviewsInformation([t])})},i=u[Symbol.iterator]();!(t=(a=i.next()).done);t=!0)o()}catch(e){n=!0,r=e}finally{try{t||null==i.return||i.return()}finally{if(n)throw r}}})})}},{key:"DATABASE_URL",get:function(){return"http://localhost:".concat(1337,"/")}},{key:"RESTAURANTS_PATH",get:function(){return c.DATABASE_URL+"restaurants"}},{key:"REVIEWS_PATH",get:function(){return c.DATABASE_URL+"reviews"}}]),c}();