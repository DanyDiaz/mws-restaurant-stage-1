var restaurant,newMap;document.addEventListener("DOMContentLoaded",function(e){initIndexedDB(),initMap(),registerServiceWorker(),addEventsForElements()}),addEventsForElements=function(){var e=document.getElementById("butSend"),n=document.getElementById("txtUserName"),r=document.getElementById("txtComment"),a=document.getElementById("lblEnterName"),i=document.getElementById("lblEnterComment"),o=document.getElementById("sRating"),t=document.getElementById("btnIgnore"),l=document.getElementById("chkMarkFavorite");t&&t.addEventListener("click",function(){hideOfflineNotification()}),l&&l.addEventListener("click",function(){var e=getParameterByName("id"),t=!1;this.checked?(document.getElementById("lblMarkFavorite").firstChild.innerHTML="Unmark as Favorite&nbsp",t=!0):document.getElementById("lblMarkFavorite").firstChild.innerHTML="Mark as Favorite&nbsp",DBHelper.markRestaurantAsFavorite(e,t)}),n&&n.addEventListener("keyup",function(e){"inline-block"==a.style.display&&0<n.value.trim().length&&(a.style.display="none"),this.value=this.value.replace(/[^a-zA-Z0-9 ]/g,"")}),r&&r.addEventListener("keyup",function(e){"inline-block"==i.style.display&&0<r.value.trim().length&&(i.style.display="none")}),e&&e.addEventListener("click",function(){var e=getParameterByName("id");if(areFieldsValid(n,r,a,i)){var t=document.getElementById("reviews-list");DBHelper.sendReview(n,r,o,e).then(function(e){n.value="",r.value="",n.focus(),e&&e.offline?(showOfflineNotification(),delete e.offline):e&&(DBHelper.sendPendingReviews(),hideOfflineNotification()),t.appendChild(createReviewHTML(e))})}})},showOfflineNotification=function(){document.getElementById("notification").style.display="flex"},hideOfflineNotification=function(){document.getElementById("notification").style.display="none"},areFieldsValid=function(e,t,n,r){return n.style.display="none",""===e.value.trim()?(e.value="",n.style.display="inline-block",e.focus(),!1):(r.style.display="none",""!==t.value.trim()||(t.value="",r.style.display="inline-block",t.focus(),!1))},initMap=function(){fetchRestaurantFromURL(function(e,t){e?console.error(e):(self.newMap=L.map("map",{center:[t.latlng.lat,t.latlng.lng],zoom:16,scrollWheelZoom:!1}),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.jpg70?access_token=sk.eyJ1IjoiZGFueWRpYXoiLCJhIjoiY2pxcTJ1dmptMDgxODQzbHB2bDk2dzJneCJ9.KEjkkpXABSLv90wwi5fKuw",{mapboxToken:"<your MAPBOX API KEY HERE>",maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(newMap),changeKeyboardBehaviorForMap(),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(self.restaurant,self.newMap))})},changeKeyboardBehaviorForMap=function(){document.getElementById("map").setAttribute("tabindex","-1")},fetchRestaurantFromURL=function(n){if(self.restaurant)n(null,self.restaurant);else{var r=getParameterByName("id");r?DBHelper.fetchRestaurantById(r,function(e,t){(self.restaurant=t)?IndexedDatabase.getPendingReviewsInformation(parseInt(r)).then(function(e){t&&t.offline?(showOfflineNotification(),delete t.offline):t&&(e&&0<e.length&&(t.reviews=t.reviews.concat(e)),DBHelper.sendPendingReviews(),hideOfflineNotification()),fillRestaurantHTML(),n(null,t)}):console.error(e)}):(error="No restaurant id in URL",n(error,null))}},createSources=function(e){var t=document.createElement("source");return t.media=e.media,t.srcset=e.srcset,t},fillRestaurantHTML=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant;document.getElementById("restaurant-name").innerHTML=e.name,e.is_favorite&&JSON.parse(e.is_favorite)&&(document.getElementById("chkMarkFavorite").checked=!0,document.getElementById("lblMarkFavorite").firstChild.innerHTML="Unmark as Favorite&nbsp"),document.getElementById("restaurant-address").innerHTML=e.address;var t=document.getElementById("restaurant-picture");e.sources.forEach(function(e){t.append(createSources(e))});var n=document.getElementById("restaurant-img");n.className="restaurant-img",n.src=DBHelper.imageUrlForRestaurant(e),n.alt=e.photographDescription,n.remove(),t.append(n),document.getElementById("restaurant-cuisine").innerHTML=e.cuisine_type,e.operating_hours&&fillRestaurantHoursHTML(),fillReviewsHTML()},fillRestaurantHoursHTML=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant.operating_hours,t=document.getElementById("restaurant-hours");for(var n in e){var r=document.createElement("tr"),a=document.createElement("td");a.innerHTML=n,r.appendChild(a);var i=document.createElement("td");i.innerHTML=e[n],r.appendChild(i),t.appendChild(r)}},fillReviewsHTML=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant.reviews,t=document.getElementById("reviews-container");if(!e){var n=document.createElement("p");return n.innerHTML="No reviews yet!",void t.appendChild(n)}var r=document.getElementById("reviews-list");e.forEach(function(e){r.appendChild(createReviewHTML(e))}),t.appendChild(r)},createReviewHTML=function(e){var t=document.createElement("li"),n=document.createElement("h4");n.innerHTML=e.name,t.appendChild(n);var r=document.createElement("p"),a=new Date(e.updatedAt);r.innerHTML=a.toLocaleDateString(),t.appendChild(r);var i=document.createElement("p");i.innerHTML="Rating: ".concat(e.rating),t.appendChild(i);var o=document.createElement("p");return o.innerHTML=e.comments,t.appendChild(o),t},fillBreadcrumb=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:self.restaurant,t=document.getElementById("breadcrumb"),n=document.createElement("li"),r=document.createElement("a");r.href="/restaurant.html?id="+e.id,r.innerHTML=e.name,r.setAttribute("aria-current","page"),n.appendChild(r),t.appendChild(n)},getParameterByName=function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]".concat(e,"(=([^&#]*)|&|#|$)")).exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null},registerServiceWorker=function(){navigator.serviceWorker&&navigator.serviceWorker.register("/service_worker.js").then(function(e){console.log("ServiceWorker registration successful with scope: ",e.scope)}).catch(function(e){console.log("Error registering service worker")})},initIndexedDB=function(){IndexedDatabase.openAndConfigureDatabase()};